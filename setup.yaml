---
  - name: "Setup for the GOOMBA bot."
    hosts: localhost
    connection: local
    become: yes
    tasks:
    - name: Find out playbook's path
      shell: pwd
      register: playbook_path_output
    - debug: var=playbook_path_output.stdout
    - name: "Install dependencies for voice chat support."
      apt:
        pkg:
          - libffi-dev
          - libnacl-dev
          - python3-dev
        state: latest
        update_cache: true
    - name: "Create venv with required modules."
      pip:
        requirements: "{{ playbook_path_output.stdout }}/requirements.txt"
        virtualenv: "{{ playbook_path_output.stdout }}/.venv"
        virtualenv_python: python3
    - name: "Create a *.txt file with a token inside of it."
      copy:
        content: "{{ BOT_TOKEN }}"
        dest: "{{ playbook_path_output.stdout }}/token.txt"
    - name: "Create a shell script for running the bot"
      copy:
        content: ".venv/bin/python3 main.py"
        dest: "{{ playbook_path_output.stdout }}/run.sh"
        mode: u=rwx,g=rwx,o=rwx
    - name: "Create a copy of the template *.service file"
      copy:
        src: "{{ playbook_path_output.stdout }}/GOOMBA.service"
        dest: "{{ playbook_path_output.stdout }}/GOOMBA_tmp.service"
        mode: u=rwx,g=rwx,o=rwx
    - name: "Replace the working directory in the *.service file."
      lineinfile:
        path: "{{ playbook_path_output.stdout }}/GOOMBA_tmp.service"
        regexp: 'WorkingDirectory'
        line: "WorkingDirectory={{ playbook_path_output.stdout }}"
        mode: '0644'
    - name: "Replace the ExecStart param in the *.service file."
      lineinfile:
        path: "{{ playbook_path_output.stdout }}/GOOMBA_tmp.service"
        regexp: 'ExecStart'
        line: "ExecStart={{ playbook_path_output.stdout }}/.venv/bin/python3 {{ playbook_path_output.stdout }}/main.py"
        mode: '0644'
    - name: "Replace the ExecStart param in the *.service file."
      lineinfile:
        path: "{{ playbook_path_output.stdout }}/GOOMBA_tmp.service"
        regexp: 'ExecStartPre'
        line: "ExecStartPre={{ playbook_path_output.stdout }}/.venv/bin/activate"
        mode: '0644'
    - name: "Move the tmp file to the proper service folder."
      command: mv {{ playbook_path_output.stdout }}/GOOMBA_tmp.service /etc/systemd/system/GOOMBA.service
    - name: "Setting permissions for the file."
      command: chown root:root /etc/systemd/system/GOOMBA.service
      command: chmod 644 /etc/systemd/system/GOOMBA.service
    - name: "Enabling autostart."
      command: systemctl daemon-reload
      command: systemctl enable GOOMBA
      command: systemctl start GOOMBA